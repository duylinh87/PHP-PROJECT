<?php get_header(); ?>


<?php $xkld_id = $_GET['xkld_id']; ?>
<div id="content">

    <div class="wrap">
        <?php bzb_breadcrumb(); ?>
        <div class="search-wrap">
        <p class="sp search-change search-close">Thay đổi điều kiện tìm kiếm</p>
        <?php if ( is_post_type_archive('vieclam') || is_tax( 'job_cat' )) : ?>
            <?php get_template_part( 'template-parts/vieclam', 'form' ); ?>
        <?php elseif( is_post_type_archive('xkld') || is_tax( 'feature_tag' ) ) : ?>
            <?php get_template_part( 'template-parts/xkld', 'form' ); ?>
        <?php endif; ?>
        </div>

        <div id="main" <?php bzb_layout_main(); ?>>

        <?php if ( is_post_type_archive('vieclam') || is_tax( 'job_cat' )) : ?>
            <h1 class="post-title">Đơn hàng tuyển dụng</h1>
        <?php elseif( is_post_type_archive('xkld') || is_tax( 'feature_tag' ) ) : ?>
            <h1 class="post-title">Danh sách công ty XKLĐ </h1>
        <?php endif; ?>

        <?php if ( is_post_type_archive('vieclam') || is_tax( 'job_cat' )) : ?>
            <?php get_template_part( 'template-parts/vieclam', 'sort' ); ?><!-- ソート -->
        <?php endif; ?>

        <?php if ( is_post_type_archive('vieclam')  ) : ?>
        
        <?php
        // 送り出し機関に紐付ける場合
        if($xkld_id){ ?>
            <!-- 募集期限切れを一覧から除外 -->
            <?php
                $date = date('Y/m/d');
                $metaquerysp[] = array(
                    'key'=>'募集期限',
                    'value'=> $date,
                    'compare' => '>=',
                    'type' => 'DATE'
                );
                $paged = get_query_var('paged') ? get_query_var('paged') : 1;
                $posts_per_page = 10;
                $args = array(
                    'post_type' => 'vieclam',
                    'meta_query' => $metaquerysp,
                    "paged" => $paged,
                    'posts_per_page' => $posts_per_page,
                    'connected_type' => 'vieclam_to_xkld',
                    'connected_items' => $xkld_id
                );
                $wp_query = new WP_Query( $args );
            
        }else{

        ?>
        <!-- 募集期限切れを一覧から除外 -->
        <?php
            $date = date('Y/m/d');
            $metaquerysp[] = array(
                'key'=>'募集期限',
                'value'=> $date,
                'compare' => '>=',
                'type' => 'DATE'
            );
            $paged = get_query_var('paged') ? get_query_var('paged') : 1;
            $posts_per_page = 10;
            $args = array(
                'post_type' => 'vieclam',
                'meta_query' => $metaquerysp,
                "paged" => $paged,
                'posts_per_page' => $posts_per_page,
            );
            $wp_query = new WP_Query( $args );
        ?>
        <?php } ?>
        <?php endif; ?>


        <?php if ( is_post_type_archive('xkld')  ) : ?>
        <?php
            $paged = get_query_var('paged') ? get_query_var('paged') : 1;
            $posts_per_page = 10;
            $args = array(
               'post_type' => 'xkld',
                "paged" => $paged,
                'posts_per_page' => $posts_per_page,
            );
            $wp_query = new WP_Query( $args );
        ?>
        <?php endif; ?>

        <?php while ( $wp_query->have_posts() ) : $wp_query->the_post(); ?>
            <?php if ( is_post_type_archive('vieclam') || is_tax('job_cat') ) : ?>
                <?php get_template_part( 'template-parts/vieclam', 'loop' ); ?>
                <?php elseif( is_post_type_archive('xkld') || is_tax( 'feature_tag' ) ) : ?>
                <?php get_template_part( 'template-parts/xkld', 'loop' ); ?>
            <?php endif; ?>

        <?php endwhile; ?>

        <?php  wp_pagenavi(); ?>
        <?php if( is_post_type_archive('xkld') ) : ?>
        <?php get_template_part('template-parts/block', 'concierge'); ?>
        <?php endif; ?>
            
        </div><!-- /main -->

    </div><!-- /wrap -->

</div><!-- /content -->

<?php get_footer(); ?>